# WIKI_PARSER_GUIDE.md - Wikiパーサー実装知見

**Version**: 2.0  
**Status**: 仕様確定 ✅  
**Last Updated**: 2025-12-14  
**分割元**: PARSING_RULES.md（行4486〜最後）

---

このドキュメントは、城プロWikiからのデータ抽出で得られた実装知見、バージョン履歴、設計決定をまとめます。

**関連ドキュメント**:
- [PARSING_RULES.md](./PARSING_RULES.md) - コア仕様（パターン1〜10）
- [PARSING_RULES_ADVANCED.md](./PARSING_RULES_ADVANCED.md) - 高度なパターン（パターン11以降）

---

## 🌐 Wikiパーサー実装知見（v2.0追加）

城プロWikiからのデータ抽出で得られた実装知見をまとめます。

### 特殊能力 vs 特殊攻撃の区別

Wikiの特技詳細表には「特殊能力」と「特殊攻撃」の2つのセクションが存在します。

- **特殊能力**: パッシブ効果。バフマトリクスで使用する。
- **特殊攻撃**: アクティブスキル。バフマトリクスでは**除外**する。

```typescript
// セクション追跡で特殊攻撃を除外
let currentSection: 'skill' | 'strategy' | 'special' | null = null;

if (text === '特技') currentSection = 'skill';
else if (text === '計略') currentSection = 'strategy';
else if (text === '特殊能力') currentSection = 'special';
else if (text === '特殊攻撃') currentSection = null;  // 無視

// 特殊攻撃セクションはスキップ
if (currentSection === null && header.includes('ストック')) continue;
```

### スキル名と説明文の分離

特技詳細表の `<td>` セルには、スキル名と説明文が同じ行にある場合があります。

```html
<td>城姫の覚醒/攻撃と防御が30%上昇</td>  <!-- スキル名/説明 -->
```

**推奨**: 複数セル行の場合、**最後の `<td>`** のみを説明文として抽出します。

### 効果重複の位置ベース検出

「効果重複」という記述は、**その前に記載されているバフにのみ**適用されます。

```
攻撃20%上昇、防御30%上昇(効果重複)
→ 「防御30%」のみが効果重複、「攻撃20%」は非重複
```

実装では、バフを抽出した後に「効果重複」の位置を確認し、直前のバフにのみ `isDuplicate: true` を設定します。

---

## 🔄 バージョン履歴

### v2.0 (2025-12-14) - 分離Statとパーサー知見

**気バフの分離Stat化**:
- `costType` フィールドを廃止
- 気の種類ごとに分離Statを使用:
  - `cost` - 自然気増加
  - `cost_gradual` - 徐々気
  - `cost_giant` - 巨大化気軽減
  - `cost_enemy_defeat` - 気(牛)
  - `cost_defeat_bonus` - 気(ノビ)
  - `cost_strategy` - 計略消費気

**徐々気パターンの厳格化**:
- 緩いパターン `/時間経過で.*?気/` は誤検知が多発
- 厳格パターン `/時間経過で気が(?:徐々に)?/` を推奨

**Wikiパーサー知見追加**:
- 特殊能力 vs 特殊攻撃の区別
- スキル名と説明文の分離方法
- 効果重複の位置ベース検出

### v1.2 (2025-12-06) - 高度なパターンと複雑なルール
- 13個の新しいパターンを発見・文書化
- **気（フィールドコスト）の概念を正しく理解** - 最も重要な修正
  - 気は個別のキャラクターではなく、編成全体で共有されるフィールドリソース
  - 全ての気バフは `target: 'field'` として表現
  - 伏兵と気の関係を明確化
  - バフパズルでの気の表示方法を設計
- **動的バフの概念を導入** - パターン21
  - 編成依存 vs 戦闘状況依存の分類
  - バフパズルでは別枠表記し、パズルから除外
  - ダメージ計算ではシナリオ管理機能で対応
  - ドレッドノートを具体例として詳細に文書化
- **手動編集機能の必要性を明確化**
  - パーサーは80-90%の精度を目指し、残りは人間が修正
  - 確信度フラグの導入
  - UI設計の方針を策定
- **条件による値の分岐（直接指定）** - パターン22
  - 「40%、近接城娘は50%」のような直接値指定パターン
  - 基本値と条件付き値を別Buffとして生成
  - 適用時に条件を満たす最大値を選択
- **武器種別条件の設計決定**
  - 近接・遠隔はConditionTagで処理（targetのModifierではない）
  - 属性条件と同じレベルの扱い（優先度6：中程度）
  - 責務の分離: targetは範囲、ConditionTagは絞り込み
- **計略範囲バフ** - パターン23
  - 範囲サイズ（超特大〜小）によるtarget分類ルール
  - 超特大〜大は`range`、中〜小は`ally`
  - noteフィールドに詳細情報を保存してシンプルさを維持
  - 伏兵の射程内バフの特殊扱い
  - 伏兵バフが動的である理由の正確な理解（配置の柔軟性と効果の多様性）
  - 気管理のための死守戦略という実態を反映
  - 新フィールド: `requiresAmbush`
- **季節属性タグの拡張**
  - 花嫁（bride）を追加
- 新しいターゲット `'field'` を追加
- 射程内と射程外で効果が異なるバフ（甲府城）
- 編成特技の除外方針を明確化
- ノックバックの4段階（少し、通常、大きく、劇的に）
- 徐々に気が増加する系の複雑なルール（文脈依存）
- 自然増加量の「増加」vs「大きく増加」
- (重複時効果減少) - スタックペナルティの概念
- (重複なし) - 最大値のみ適用のルール
- 対象が暗黙的な複雑な文章構造
- 型定義の拡張: `stackPenalty`, `nonStacking`, `priority`, `out_of_range`, `field`, `isDynamic`, `dynamicType`, `confidence`, `requiresAmbush`

### v1.1 (2025-12-06) - 追加パターン対応
- 11個の新しいパターンを発見・文書化
- 特技発動条件マーカー（【配置】【水上】）
- 発動トリガー付きバフ（「敵撃破毎に」）
- 明示されない鼓舞の検出
- 除外条件（「自身を除く」）
- 直撃ボーナスの特殊な表記
- 自己適用時の倍率
- 「攻撃が○倍のダメージを与える」パターン
- 「同種効果と重複」が「効果重複」の別表記であることを確認
- 効果の上限回数
- HP/耐久が同じ意味であることを確認
- 爆風範囲・爆風ダメージ

### v1.0 (2025-12-06)
- 初版作成
- 基本ルール、特殊処理、具体例の分析を完全に文書化
- 5つの重要な設計決定を実施
- テストケースを豊富に記載

---

## 📚 関連ドキュメント

- `TYPE_CONVERSION_MAPPING.md` - 型変換の完全仕様
- `TARGET_NORMALIZATION.md` - Target正規化ルール
- `CONDITION_TAG_SPEC.md` - ConditionTag仕様
- `ARCHITECTURE.md` - プロジェクト全体の設計書
- `src/core/parser/buffParser.ts` - パーサーの実装（これから作成）
- `src/core/parser/patterns.ts` - 正規表現パターン定義（これから作成）

---

## 🎯 重要な設計決定のまとめ

### 設計決定1: 「全ての敵」と「巨大化する度に」の関係

**決定内容**: 新しい範囲指定が出現しても、明示的な分節（「。」）または新しい接頭辞が出現するまで、接頭辞の影響は継続する。

**理由**: 城プロの文法では、範囲の変更は接頭辞のスコープをリセットしない。同じ文の中であれば、同じ接頭辞の影響下にあると解釈するのが自然。

**実装への影響**: giantMultiplierScopeのような設定フラグを用意し、将来的に解釈を切り替えられるようにする。

### 設計決定2: 「同種効果の重複無し」のフラグ表現

**決定内容**: 新しいフラグ`isExplicitlyNonDuplicate`を追加する。

**理由**: 「明示的に重複無し」という情報は、将来的に役立つ可能性がある。UIで注意書きを表示できる。デフォルトと区別できる。

**実装への影響**: Buff型に`isExplicitlyNonDuplicate?: boolean`を追加。

### 設計決定3: 条件付きバフの表現方法

**決定内容**: 別々のバフとして生成する（方法A）。

**理由**: 型定義がシンプル。バフの適用判定ロジックが明確。将来的にON/OFF制御が容易。

**実装への影響**: 「基本バフ」と「条件付きバフ」の2つのBuffを生成。実際の適用時は、キャラクターの状態に応じてどちらか一方が適用される。

### 設計決定4: 継続回復・継続ダメージの扱い

**決定内容**: 備考フィールドに記録し、パースはスキップ。

**理由**: 編成パズルやダメージ計算では扱えない時間経過効果。無視すると情報が失われる。将来的に拡張する可能性を残す。

**実装への影響**: Buff型に`note?: string`フィールドを追加。継続効果は特別なオブジェクト（type: 'note'）として記録。

### 設計決定5: 特技効果の倍率の扱い

**決定内容**: 計略の特殊効果として別途管理。Strategy型にspecialEffectsフィールドを追加（将来の拡張）。

**理由**: これはバフではなく、既存のバフへの倍率効果。Buff型では表現できない。計略専用の拡張が必要。

**実装への影響**: 現時点では実装しない。将来的にStrategy型とSpecialEffect型を定義し、特技効果の倍率や継続回復を管理できるようにする。

---

## 🙏 最後に

このPARSING_RULES.mdは、城プロREのテキストパースという難問を解決するための、完全なガイドラインです。実装時には、このドキュメントを参照しながら、一つ一つのルールを確実に実装してください。

また、新しいエッジケースが見つかった場合は、このドキュメントを更新し、知見を蓄積していってください。

頑張ってください！

---

**Document Version**: 2.0  
**Created**: 2025-12-06  
**Last Updated**: 2025-12-14  
**Status**: 仕様確定 ✅
