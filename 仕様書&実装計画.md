ShiroPro Tools (Reborn) 仕様書 & 実装計画

## 1. プロジェクト概要
- 目的: 城プロRE向けに「編成作成・バフ可視化・簡易ダメージ計算」を行うWebアプリを React + TypeScript で再構築。
- 特徴: 既存ツールの学びを反映し、堅牢・拡張性重視。

## 2. UXゴール
- 一目で把握: 編成の強み/弱点（不足バフ）を即座に理解。
- スムーズ操作: Wikiインポート→編成→計算がノンストレス。
- パズル感: 入替でバフ穴が埋まる楽しさ。

## 3. 技術スタック
- Framework: React 18+
- Language: TypeScript
- Build: Vite
- Styling: TailwindCSS v4
- State: React Context + useReducer（または Zustand）
- Test: Vitest

## 4. 機能要件 & UI設計
### 4.1 全体レイアウト（SPA）
- 3セクション構成。主要情報はスクロールなしで把握可能な密度。

### 4.2 ヘッダー & 編成エリア（Formation）
- 8キャラ枠: 名前表示。属性（平/平山/水/山/地獄）は背景色、武器種はアイコン。
- 入替: まずはクリック選択→入替。将来 DnD。
- マップ制約: 例「山城3体まで」「遠隔2体まで」。違反枠を赤ハイライト。
- Wikiインポート: 画面隅に配置し邪魔にならないように。

### 4.3 バフ・マトリックス（Buff Matrix, メインビュー）
- 目的: 数値羅列ではなく「パズル盤面」的理解。
- セル表示（2段）:
  - 上段: ドットでバフ供給元を簡易表示。
  - 下段: スタックバーで内訳。色: 青=自前, 緑=味方, 紫=計略/鼓舞。
- 行サマリー: 右端に理想値ゲージ。赤(不足)→緑(適正)→青(過剰)。不足時 ⚠ バッジ。
- グルーピング/モード:
  - 折り畳みカテゴリ: 基本(攻/防/射), サブ(短縮/気), その他。
  - 表示モード: パズル（簡易） / ガチ勢（詳細数値＋バー）。

### 4.4 アタッカー分析ビュー（別画面/ルート）
- バフ積み上げバー: [基礎][自前][編成][鼓舞][What-if] で最終攻撃力を可視化。
- レーダーチャート軸: 有効DPS / 射程 / 手数(ASPD) / コスト効率 / 自己完結度。
- DPS vs 射程散布図: 立ち位置を可視化。
- What-ifシミュレーション: 仮想バフを半透明ブロックで追加し伸び幅を表示。

## 5. データ構造（TypeScript）
```ts
type Stat = 'attack' | 'defense' | 'range' | 'cooldown' | 'cost' | 'damage_dealt' | 'damage_taken';
type BuffMode = 'percent_max' | 'flat_sum'; // 最大値適用 or 合算
type ConditionTag = 'melee' | 'ranged' | 'water' | 'mountain' | 'flat' | 'hell' | 'hp_below_50' | 'strategy_active';

interface Buff {
  id: string;
  stat: Stat;
  mode: BuffMode;
  value: number;
  source: 'self_skill' | 'ally_skill' | 'strategy' | 'formation_skill';
  target: 'self' | 'range' | 'all';
  conditionTags?: ConditionTag[];
  isActive: boolean;
}

interface Character {
  id: string;
  name: string;
  weapon: string;
  attributes: string[]; // 平, 水, etc.
  baseStats: Record<Stat, number>;
  skills: Buff[];
  strategies: Buff[];
}

interface Formation {
  slots: (Character | null)[]; // 8枠
}
```

## 6. アーキテクチャ
- Core/UI 分離:
  - `src/core`: 計算ロジック・データモデル・Wiki解析（純粋関数、React非依存）。
  - `src/ui`: Core結果を表示するReactコンポーネント群。
- 状態管理:
  - Global: CharacterDB, Formation, MapConstraints
  - Local: UI state（モーダル開閉、入力値など）
- Wikiインポート3層:
  - Fetcher: HTML取得
  - RawParser: HTML→RawData（テキスト抽出）
  - Analyzer: RawData→Character（正規化/Buff変換）

## 7. 実装フェーズ
- Phase 1: プロジェクト初期化 & Core基盤
  - Vite+React+TS セットアップ、型定義整備。
  - TDDで `calcBuffMatrix` と `isBuffApplicable` を実装。
  - 手入力データで動く最小UIを用意し計算ロジック検証。
- Phase 2: Wikiインポート
  - Fetcher/RawParser/Analyzer を実装しテスト重点。
  - UIにインポートを組み込み Core と接続。
- Phase 3: UI/UX深化
  - リッチマトリクスUI（スタックバー、理想ゲージ、モード切替）。
  - アタッカー分析（積み上げバー、レーダー、散布図、What-if）。
- Phase 4: 仕上げ & 共有
  - `serializeState` / `deserializeState`（URL共有・LocalStorage）。
  - Map制約プリセット。
  - オンボーディングとサンプルデータロード。
